### 网络层定义与功能  
>
>> - 局域网——资源子网
>> - 广域网——通信子网
>
> OSI——定义网络设备间如何传输数据；根据唯一的网络设备地址路由数据包；提供流量和拥塞控制以防止网络资源的损耗。（虚电路服务）  
>> ![image1](https://github.com/onshero/PCN/blob/picture/虚电路服务.png)  
>
> TCP/IP——网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务，这就是IP（Internet Protocol）的主要功能。（数据报服务）  
>> ![image2](https://github.com/onshero/PCN/blob/picture/数据报服务.png)  
>
> ![image3](https://github.com/onshero/PCN/blob/picture/虚电路与数据报服务的对比.png)  
> 基于IP协议的虚拟互联网络可以屏蔽掉网络的差异性  
> 使用IP网的好处：  
>> 当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。——透明  
>> 造价大大降低  
>> 运行方式灵活  
>> 网络可靠性提高  
>> 能够适应多种应用  
>
> IP网的分组交换过程：独立的路径选择、存储转发  
> 异构网络互连的中间设备——`路由器Router`

### IP地址  
> IP地址就是给每个连接在因特网上的主机（或路由器）分配一个在全世界范围是唯一的32位的标识符。（IPv4）  
> IP地址现在由因特网名称与号码分配机构ICANM(Internet Corporation for Assigned Names and Numbers)进行分配  
>> ![image4](https://github.com/onshero/PCN/blob/picture/分配联盟.png)  
> 
> IP地址的编址方法  
>> 分类的IP地址。这是最基本的编址方法，在1981年就通过了相应的标准协议。——固定分类  
>>> 分成A、B、C、D、E 5类地址。  
>>> 每一类地址都由两个固定长度的字段组成
>>>> 其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络。  
>>>> 另一个字段则是主机号 host-id，它标志该主机（或路由器）。  
>>>
>>> ![image5](https://github.com/onshero/PCN/blob/picture/传统IP地址分类.png)  
>>> ![image6](https://github.com/onshero/PCN/blob/picture/点分十进制记法.png)  
>>> ![image7](https://github.com/onshero/PCN/blob/picture/特殊IP地址.png)  
>>> ![image8](https://github.com/onshero/PCN/blob/picture/特殊IP地址（2）.png)  
>>>> 网络地址转换NAT(Network Address Translation 1994)的过程  
>>>>> 内部主机 X 用本地地址 IPX 和因特网上主机 Y 通信，所发送的数据报必须经过 NAT 路由器。  
>>>>> NAT 路由器将数据报的源地址 IPX 转换成全球地址 IPG，但目的地址 IPY 保持不变，然后发送到因特网。  
>>>>> NAT 路由器收到主机 Y 发回的数据报时，根据 NAT 转换表，将目的地址 IPG 转换为 IPX，转发给最终的内部主机 X。  
>>>
>>> ![image9](https://github.com/onshero/PCN/blob/picture/常用的三种类别的IP地址.png)  
>>> ![image10](https://github.com/onshero/PCN/blob/picture/IP地址的特点.png)   
>>> 互联网中的IP地址  
>>>> 在同一个局域网上的主机或路由器的IP地址中的`网络号`必须是一样的，`主机号`是不同的。  
>>>> 路由器总是具有`两个或两个以上`的IP地址。  
>>
>> 子网的划分。这是对最基本的编址方法的改进，其标准[RFC 950]在1985年通过。——子网掩码  
>> 构成超网。无分类编址方式。1993年提出后很快就得到推广应用。——变长掩码  
>

### IP数据封装格式
> 每个计算机终端设备及路由器都要配置IP协议，明确自己的IP地址  
> 每个发送出来的分组都要携带着地址信息，才能找到目的地  
> 一个IP数据报由首部和数据两部分组成。
>> 首部分为两部分：  
>>> 前一部分是`固定长度`，共`20`字节，是所有IP数据报必须具有的。  
>>> 后一部分是一些`可选字段`，长度可变  
>>>> 可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富  
>>>> 长度可变，从1个字节到40个字节不等，取决于所选的项目  
>>>> 增加首部的可变部分是为了增加IP数据报的功能，但这同时也使得IP数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销  
>>>> 实际上这些选项很少被使用  
>>
>> ![image11](https://github.com/onshero/PCN/blob/picture/IP数据报.png)  
>>> 版本——占4位，指IP协议的版本，目前的IP协议版本号为4（即IPv4）  
>>> 首部长度——占4位，可表示的最大数值是15个单位（一个单位为4字节），因此`IP的首部长度的最大值是60字节`  
>>> 区分服务——占8位，用来获得更好的服务——在旧标准中叫做服务类型，但实际一直未被使用过。1998年改名。只有在使用区分服务（DiffServ）时，这个字段才起作用。一般情况下不使用  
>>> 总长度——占16位，指首部与数据之和的长度，单位为字节，因此数据报的最大长度为65535字节。总长度必须不超过链路要求的最大传送单元MTU，否则会被切片  
>>> 标识——占16位，是个计数器，用来产生数据报的标识  
>>> 标志——占3位，实际只有2位起作用。最低位为MF，为1表示后面还有分片，为0表示最后一个分片；中间位为DF，只有为0时才允许分片  
>>> 片偏移——占12位，指出较长的分组在分片后某片在原分组中的相对位置，以8字节为便宜单位  
>>> 生存时间TTL——占8位，数据报在网络中可通过的路由器数（跳数）的最大值。每经过一个路由器转发就减1，为0时丢弃  
>>> 协议——占8位，指出此数据报携带的数据使用何种协议以便目的主机的IP层将数据部分上交到哪个处理过程  
>>> 首部检验和——占16位，只检验数据报的首部，采用加和处理，进行比特级的差错判断  
>>> 源地址和目的地址都各占4字节  
>

### 基本路由过程  
> 查找路由表  
> 路由表里包含：所有连接的网络号及端口号的对应关系  
> 举例  
> ![image12](https://github.com/onshero/PCN/blob/picture/基本路由过程.png)  
> 基本的分组转发算法  
>> （1）从数据报的首部提取目的主机的IP地址D，得出目的网络地址为N  
>> （2）若网络N与此路由器直接相连，则把数据报直接交付目的主机D；否则是间接交付，执行（3）  
>> （3）若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一级路由器；否则执行（4）  
>> （4）若路由表中有到达网络N的路由，则把数据报传送给路由表指明的下一级路由器；否则执行（5）  
>> （5）若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则执行（6）  
>> （6）报告转发分组出错  
>
> 特定路由（指定路由）：指明了到达某个主机走的路径或到达某个网络应该走的路径  
> 默认路由（默认网关）：前面都不符合，用最后用x.x.x.x所代表的一个缺省的路由  

### ARP协议  
> 与IP协议配套使用的四个协议  
>> 地址解析协议 ARP（Address Resolution Protocol）：把一个32比特的IP地址转换为48比特的物理地址  
>> 逆地址解析协议 RARP（Reverse Address Resolution Protocol）：负责把物理地址反向转换成IP地址  
>> 网际控制报文协议 ICMP（Internet Control Message Protocol）：负责网络层的错误诊断、查询服务等等，来帮助不可靠的IP协议解决一些可靠问题  
>> 网际组管理协议 ICMP（Internet Group Management Protocol）：协助处理点到多点的传输  
>
> （1）地址解析协议 ARP  
>> ![image13](https://github.com/onshero/PCN/blob/picture/地址解析协议ARP.png)  
>> IP地址与MAC地址的关系
>> ![image14](https://github.com/onshero/PCN/blob/picture/IP地址与MAC地址的关系.png)  
>
> （2）ARP工作原理  
>> 每个主机（包括路由器）都设有一个ARP高速缓存（ARP cache）  
>>> 里面有所在局域网上的各主机和路由器的IP地址到硬件地址的映射表  
>>
>> 当主机A欲向本局域网上的某主机B发生IP数据报时，就先在其ARP高速缓存中查看有无主机B的IP地址  
>>> 如有，就可查出其对应的硬件地址，再将此硬件地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址  
>>> 如无，则通过广播请求获取所需地址，并告知自己的地址信息  
>>> ![image15](https://github.com/onshero/PCN/blob/picture/用于以太网的ARP请求或应答分组格式.png)  
>>> ![image16](https://github.com/onshero/PCN/blob/picture/ARP请求及应答.png)  
>>
>
> **注意**  
>> ARP工作在局域网中，是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题。用于：
>> * 主机—>主机  
>> * 主机—>路由器  
>> * 路由器—>路由器  
>> * 路由器—>主机  
>
> ARP缓存表的形式  
>> ![image17](https://github.com/onshero/PCN/blob/picture/ARP缓存表形式.png)  
>
> 如何映射  
>> ![image18](https://github.com/onshero/PCN/blob/picture/ARP工作图解.png)  
>> 强调
>> 1、当路由器收到待转发的数据报，不是将下一跳路由器的IP地址填入IP数据报，而是送交下层的网络接口软件。（目的IP不变）  
>> 2、网络接口软件使用ARP将下一跳路由器的IP地址转换成硬件地址，并将此硬件地址放在链路层的MAC帧的首部，然后根据这个硬件地址找到下一跳路由器（MAC变）  

### ICMP协议
### 划分子网
### 构造超网
### 路由选择协议
