### 网络层定义与功能  
>
>> - 局域网——资源子网
>> - 广域网——通信子网
>
> OSI——定义网络设备间如何传输数据；根据唯一的网络设备地址路由数据包；提供流量和拥塞控制以防止网络资源的损耗。（虚电路服务）  
>> ![image1](https://github.com/onshero/PCN/blob/picture/虚电路服务.png)  
>
> TCP/IP——网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务，这就是IP（Internet Protocol）的主要功能。（数据报服务）  
>> ![image2](https://github.com/onshero/PCN/blob/picture/数据报服务.png)  
>
> ![image3](https://github.com/onshero/PCN/blob/picture/虚电路与数据报服务的对比.png)  
> 基于IP协议的虚拟互联网络可以屏蔽掉网络的差异性  
> 使用IP网的好处：  
>> 当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。——透明  
>> 造价大大降低  
>> 运行方式灵活  
>> 网络可靠性提高  
>> 能够适应多种应用  
>
> IP网的分组交换过程：独立的路径选择、存储转发  
> 异构网络互连的中间设备——`路由器Router`

### IP地址  
> IP地址就是给每个连接在因特网上的主机（或路由器）分配一个在全世界范围是唯一的32位的标识符。（IPv4）  
> IP地址现在由因特网名称与号码分配机构ICANM(Internet Corporation for Assigned Names and Numbers)进行分配  
>> ![image4](https://github.com/onshero/PCN/blob/picture/分配联盟.png)  
> 
> IP地址的编址方法  
>> 分类的IP地址。这是最基本的编址方法，在1981年就通过了相应的标准协议。——固定分类  
>>> 分成A、B、C、D、E 5类地址。  
>>> 每一类地址都由两个固定长度的字段组成
>>>> 其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络。  
>>>> 另一个字段则是主机号 host-id，它标志该主机（或路由器）。  
>>>
>>> ![image5](https://github.com/onshero/PCN/blob/picture/传统IP地址分类.png)  
>>> ![image6](https://github.com/onshero/PCN/blob/picture/点分十进制记法.png)  
>>> ![image7](https://github.com/onshero/PCN/blob/picture/特殊IP地址.png)  
>>> ![image8](https://github.com/onshero/PCN/blob/picture/特殊IP地址（2）.png)  
>>>> 网络地址转换NAT(Network Address Translation 1994)的过程  
>>>>> 内部主机 X 用本地地址 IPX 和因特网上主机 Y 通信，所发送的数据报必须经过 NAT 路由器。  
>>>>> NAT 路由器将数据报的源地址 IPX 转换成全球地址 IPG，但目的地址 IPY 保持不变，然后发送到因特网。  
>>>>> NAT 路由器收到主机 Y 发回的数据报时，根据 NAT 转换表，将目的地址 IPG 转换为 IPX，转发给最终的内部主机 X。  
>>>
>>> ![image9](https://github.com/onshero/PCN/blob/picture/常用的三种类别的IP地址.png)  
>>> ![image10](https://github.com/onshero/PCN/blob/picture/IP地址的特点.png)   
>>> 互联网中的IP地址  
>>>> 在同一个局域网上的主机或路由器的IP地址中的`网络号`必须是一样的，`主机号`是不同的。  
>>>> 路由器总是具有`两个或两个以上`的IP地址。  
>>
>> 子网的划分。这是对最基本的编址方法的改进，其标准[RFC 950]在1985年通过。——子网掩码  
>> 构成超网。无分类编址方式。1993年提出后很快就得到推广应用。——变长掩码  
>

### IP数据封装格式
> 每个计算机终端设备及路由器都要配置IP协议，明确自己的IP地址  
> 每个发送出来的分组都要携带着地址信息，才能找到目的地  
> 一个IP数据报由首部和数据两部分组成。
>> 首部分为两部分：  
>>> 前一部分是`固定长度`，共`20`字节，是所有IP数据报必须具有的。  
>>> 后一部分是一些`可选字段`，长度可变  
>>>> 可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富  
>>>> 长度可变，从1个字节到40个字节不等，取决于所选的项目  
>>>> 增加首部的可变部分是为了增加IP数据报的功能，但这同时也使得IP数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销  
>>>> 实际上这些选项很少被使用  
>>
>> ![image11](https://github.com/onshero/PCN/blob/picture/IP数据报.png)  
>>> 版本——占4位，指IP协议的版本，目前的IP协议版本号为4（即IPv4）  
>>> 首部长度——占4位，可表示的最大数值是15个单位（一个单位为4字节），因此`IP的首部长度的最大值是60字节`  
>>> 区分服务——占8位，用来获得更好的服务——在旧标准中叫做服务类型，但实际一直未被使用过。1998年改名。只有在使用区分服务（DiffServ）时，这个字段才起作用。一般情况下不使用  
>>> 总长度——占16位，指首部与数据之和的长度，单位为字节，因此数据报的最大长度为65535字节。总长度必须不超过链路要求的最大传送单元MTU，否则会被切片  
>>> 标识——占16位，是个计数器，用来产生数据报的标识  
>>> 标志——占3位，实际只有2位起作用。最低位为MF，为1表示后面还有分片，为0表示最后一个分片；中间位为DF，只有为0时才允许分片  
>>> 片偏移——占12位，指出较长的分组在分片后某片在原分组中的相对位置，以8字节为便宜单位  
>>> 生存时间TTL——占8位，数据报在网络中可通过的路由器数（跳数）的最大值。每经过一个路由器转发就减1，为0时丢弃  
>>> 协议——占8位，指出此数据报携带的数据使用何种协议以便目的主机的IP层将数据部分上交到哪个处理过程  
>>> 首部检验和——占16位，只检验数据报的首部，采用加和处理，进行比特级的差错判断  
>>> 源地址和目的地址都各占4字节  
>

### 基本路由过程  
> 查找路由表  
> 路由表里包含：所有连接的网络号及端口号的对应关系  
> 举例  
> ![image12](https://github.com/onshero/PCN/blob/picture/基本路由过程.png)  
> 基本的分组转发算法  
>> （1）从数据报的首部提取目的主机的IP地址D，得出目的网络地址为N  
>> （2）若网络N与此路由器直接相连，则把数据报直接交付目的主机D；否则是间接交付，执行（3）  
>> （3）若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一级路由器；否则执行（4）  
>> （4）若路由表中有到达网络N的路由，则把数据报传送给路由表指明的下一级路由器；否则执行（5）  
>> （5）若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则执行（6）  
>> （6）报告转发分组出错  
>
> 特定路由（指定路由）：指明了到达某个主机走的路径或到达某个网络应该走的路径  
> 默认路由（默认网关）：前面都不符合，用最后用x.x.x.x所代表的一个缺省的路由  

### ARP协议  
> 与IP协议配套使用的四个协议  
>> 地址解析协议 ARP（Address Resolution Protocol）：把一个32比特的IP地址转换为48比特的物理地址  
>> 逆地址解析协议 RARP（Reverse Address Resolution Protocol）：负责把物理地址反向转换成IP地址  
>> 网际控制报文协议 ICMP（Internet Control Message Protocol）：负责网络层的错误诊断、查询服务等等，来帮助不可靠的IP协议解决一些可靠问题  
>> 网际组管理协议 IGMP（Internet Group Management Protocol）：协助处理点到多点的传输  
>
> （1）地址解析协议 ARP  
>> ![image13](https://github.com/onshero/PCN/blob/picture/地址解析协议ARP.png)  
>> IP地址与MAC地址的关系
>> ![image14](https://github.com/onshero/PCN/blob/picture/IP地址与MAC地址的关系.png)  
>
> （2）ARP工作原理  
>> 每个主机（包括路由器）都设有一个ARP高速缓存（ARP cache）  
>>> 里面有所在局域网上的各主机和路由器的IP地址到硬件地址的映射表  
>>
>> 当主机A欲向本局域网上的某主机B发生IP数据报时，就先在其ARP高速缓存中查看有无主机B的IP地址  
>>> 如有，就可查出其对应的硬件地址，再将此硬件地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址  
>>> 如无，则通过广播请求获取所需地址，并告知自己的地址信息  
>>> ![image15](https://github.com/onshero/PCN/blob/picture/用于以太网的ARP请求或应答分组格式.png)  
>>> ![image16](https://github.com/onshero/PCN/blob/picture/ARP请求及应答.png)  
>>
>
> **注意**  
>> ARP工作在局域网中，是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题。用于：
>> * 主机—>主机  
>> * 主机—>路由器  
>> * 路由器—>路由器  
>> * 路由器—>主机  
>
> ARP缓存表的形式  
>> ![image17](https://github.com/onshero/PCN/blob/picture/ARP缓存表形式.png)  
>
> 如何映射  
>> ![image18](https://github.com/onshero/PCN/blob/picture/ARP工作图解.png)  
>> 强调
>> 1、当路由器收到待转发的数据报，不是将下一跳路由器的IP地址填入IP数据报，而是送交下层的网络接口软件。（目的IP不变）  
>> 2、网络接口软件使用ARP将下一跳路由器的IP地址转换成硬件地址，并将此硬件地址放在链路层的MAC帧的首部，然后根据这个硬件地址找到下一跳路由器（MAC变）  

### ICMP协议
> 为了提高IP数据报交付成功的机会，在网际层使用了网际控制报文协议ICMP。  
> ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告。  
> ICMP不是高层协议，而是IP层的协议。  
> ICMP报文作为IP层数据报的数据，加上数据报的首部，组成IP数据报发送出去。  
>
> （1）ICMP报文的格式  
>> ![image19](https://github.com/onshero/PCN/blob/picture/ICMP报文的格式.png)  
> （2）ICMP报文的种类  
>> ICMP差错报告报文  
>>> 终点不可达  
>>> 源点抑制  
>>> 时间超时  
>>> 参数问题  
>>> 改变路由（重定向）  
>>
>> ICMP询问报文  
>>> 回送请求和应答  
>>> 时间戳请求和应答  
>>
>
> 常用网络命令  
>> ping（后面携带目的主机的IP地址或域名地址）  
>>> 用来测试两个主机之间的连通性  
>>> 使用了ICMP回送请求和回送回答报文  
>>
>> ipconfig  
>>> 查看当前计算机系统的IP协议配置情况  
>>
>> arp
>>> 查看arp高速缓存的内容  
>>
>> route  
>>> 查看当前主机的路由表，进行路由表的修改  
>>
>> tracert  
>>> 以ping命令为核心，查看到目的主机所经过的所有的路由器的情况，常用于判断路由设置是否符合要求  
>>
>> netstat  
>>> 判断当前网络连接情况  
>

### 划分子网（subnetting）
> 1、传统分类IP地址的问题  
>> IP地址空间的利用率有时很低  
>>> 按网段大块分配，独占不能拆分、部分回收或转让    
>>
>> 路由表变得太大，网络性能降低  
>>> 每个物理网络都有一个网络号  
>>
>> 管理不够灵活  
>>> 网络有增减，地址需适应  
>
> 2、三级IP地址  
>> 在IP地址中又增加了一个“子网号字段”，使两级的IP地址变成了三级的IP地址。  
>> 这种做法叫做划分子网。1985年“划分子网”成为因特网的正式标准协议。  
>> 从主机号借用若干个位作为子网号，而主机号也就相应的减少了若干个位。  
>>> IP地址 ::={<网络号>,<子网号>,<主机号>}  
>>> 若用4位作为子网号，那么就划分了16个子网。每个子网里面有2<sup>n</sup>-2个主机地址，要去掉全0和全1两个特殊地址  
>> 
>> 注意  
>>> 划分子网会浪费一部分地址，但可以提高总体利用率。  
>>> 划分子网时需要考虑子网个数及子网中主机个数的限制要求。  
>>> 划分子网纯属一个单位内部的事情。单位对外仍表现为没有划分子网的网络。对原有协议改变不大。  
>>
>> 路由过程  
>>> 先按目的地址的网络号找到网络  
>>> 再按子网号找到子网络  
>>> 最后按主机号找到目的主机  
>>
>> 子网掩码  
>>> 从一个IP数据报的首部无法判断源主机或目的主机所连接的网络是否进行了子网划分。  
>>> 使用子网掩码（subnet mask）可以找出IP地址中的子网部分.  
>>>> (IP地址) `AND` (子网掩码) = 网络地址  
>>>
>>> 默认子网掩码  
>>>> A类地址：255.0.0.0  
>>>> B类地址：255.255.0.0  
>>>> C类地址：255.255.255.0  
>>
>> 子网掩码是一个重要属性  
>>> 网络中每个主机接口有一个IP地址就应该有一个子网掩码。  
>>> 若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码。  
>>> 路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。路由器间交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。  
>>
>> 同样的IP地址和不同的子网掩码可以得出相同的网络地址，但子网的规模和个数不同。  
>> 使用子网掩码的分组转发过程  
>>> （1）从收到的分组的首部提取目的IP地址D。  
>>> （2）先用各网络的子网掩码和D逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行（3）  
>>> （3）若路由表中有目的地址为D的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行（4）  
>>> （4）对路由表中的每一行的子网掩码和D逐位相“与”，若其结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行（5）  
>>> （5）若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行（6）  
>>> （6）报告转发分组错误  
>>
>> 划分子网好处：  
>>> 提高地址利用效率  
>>> 减小广播与的范围  
>>> 提高安全性  
>>> 便于管理  
>>> 对原有协议改变较小  
>

### 构造超网
> 划分子网缓解了地址资源利用的问题，但也存在不够灵活等问题——`固定网络号长度`  
> 因特网主干网上的路由表中的项目数急剧增长（从几千个增长到几万个），`效率下降`  
> 无分类域间路由选择CIDR  
>> 进一步提高地址资源利用率  
>>> 可同时使用几个不同的子网掩码——可变长子网掩码VLSM（VariableLength Subnet Mask）进一步提高IP地址资源的利用率  
>>> 在VLSM的基础上——无分类编址方法，它的正式名字是`无分类域间路由选择 CIDR`（Classless Inter-Domain Routing）  
>
> CIDR最主要的特点  
>> CIDR消除了传统的A类、B类和C类地址以及划分子网的概念，因而可以更加有效地分配IPv4的地址空间。  
>> CIDR使用各种长度的“网络前缀”（network-prefix）来代替分类地址中的网络号和子网号。  
>> IP地址从三级编址又回到了两级编址。  
>
> CIDR的表示方法  
>> 无分类的两级编址的记法是：
>>> IP地址 ::={<网络前缀>,<主机号>} CIDR使用“斜线记法”，即在IP地址后面加上一个斜线“/”，然后写上网络前缀所占的位数。也可称为“掩码”。如：128.14.32.0/20  
>
> CDIR地址块  
>> CDIR把网络前缀都相同的连续的IP地址组成“CDIR地址块”  
>> 全0和全1的主机号地址一般不使用  
>
> 构造超网——CDIR的路由聚合作用   
>> 一个CDIR地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个原来传统分类地址的路由。  
>> 构成超网。  
>
> 最长前缀匹配（最长匹配、最佳匹配）  
>> 使用CDIR时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止一个匹配结果。  
>> 应当从匹配结果中选择具有最长网络前缀的路由：最长前缀匹配（longest-prefix matching）。  
>> 网络前缀越长，其地址块越小，因而路由就越具体。  
>
> 对有效利用IP地址，划分子网和构造超网有一定的缓解效果，但无法从根本上解决IPv4地址资源问题。——IPv6发展  

### 路由选择协议
> 理想的路由算法  
>> 正确与完整  
>> 计算上简单  
>> 自适应性  
>> 稳定性  
>> 公平性  
>> 最佳的（合理的）
>
> 静态路由选择策略——非自适应路由选择  
>> 其特点是简单与开销较小，但不能及时适应网络状态的变化  
>
> 动态路由选择策略——自适应路由选择  
>> 其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大  
>> 内部路由（网关）协议和外部路由（网关）协议  
>
> 自制系统(单一技术管理下的一组路由器)与（内、外）网关协议的关系  
>> 自制系统里适应内部网关协议（如RIP、OSPF），自制系统间使用外部网关协议（如BGP）  
>
> RIP  
>> 一种分布的基于距离向量的路由选择协议  
>> “距离”也称“跳数”，每经过一个路由器，跳数加1  
>> 从一路由器到直接连接的网络的距离定义为1  
>> 从一路由器到非直接连接的网络的距离定义为所经过的路由器数加1  
>> 三个要点：
>>> 仅和相邻路由器交换信息  
>>> 交换的信息是当前本路由器所知道的全部信息，即自己的路由表  
>>> 按固定的时间间隔交换路由信息  
>>
>> 路由表的建立过程  
>>> 路由器在刚刚开始工作时，只知道直接连接的网络的距离（此距离定义为1）  
>>> 以后，每个路由器也只和数目非常有限的相邻路由器交换并更新路由信息  
>>> 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址  
>>> 收敛过程较快  
>>
>> RIP的报文格式  
>>> ![image20](https://github.com/onshero/PCN/blob/picture/RIP的报文格式.png)  
>>
>> 优点：实现简单，开销较小。  
>> 缺点：
>>> 网络规模受限（最大距离为15）  
>>> 开销随网络扩大而增加  
>>> 坏消息传得慢  
>>
>
> OSPF  
>> 基本特点  
>>> “开放”。不受某一家厂商控制，而是公开发表的  
>>> “最短路径优先”。使用了Dijkstra提出的最短路径算法SPF  
>>> 是分布式的链路状态协议  
>>
>> 基本原理：三个要点  
>>> 向本自治系统的所有路由器发送信息，使用的是洪泛法  
>>> 发送的信息就是与本路由器相邻的所有路由器的链路状态（部分信息）  
>>>> “链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”  
>>>
>>> 只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息（刷新）  
>>
>> 链路状态数据库  
>>> 由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库  
>>> 这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的（这称为链路状态数据库的同步）  
>>> OSPF的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。OPSF的更新过程收敛得快是其重要优点  
>>
>> OSPF的区域  
>>> 为了使OSPF能够用于规模很大的网络，OPSF将一个自治系统再划分为若干个更小的范围，叫做区域  
>>> 每个区域都有一个32位的区域标识符（用点分十进制表示）  
>>> 区域也不能太大，在一个区域内的路由器最好不超过200个  
>>
>> OSPF的分组格式  
>>> ![image21](https://github.com/onshero/PCN/blob/picture/OSPF的分组格式.png)  
>>
>> OSPF的五种分组类型  
>>> 问候（Hello）分组  
>>> 数据库描述（Database Description）分组  
>>> 链路状态请求（Link State Request）分组  
>>> 链路状态更新（Link State Update）分组 <sub>用洪泛法对全网更新链路状态</sub>  
>>> 链路状态确认（Link State Acknowledgment）分组  
>>
>> 特点  
>>> 与网络规模无关  
>>>> 由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此当互联网规模很大时，OSPF协议要比距离向量RIP好得多  
>>>
>>> OSPF没有“坏消息传播得慢”的问题  
>>>> 据统计，其响应网络变化的时间小于100ms  
>>>
>>> 动态刷新  
>>>> OSPF还规定每隔一段时间（如30分钟），要刷新一次数据库中的链路状态  
>>>
>>
>
> 外部网关协议BGP—边界网关协议  
>> BGP是不同自治系统的路由器之间交换路由信息的协议  
>> BGP较新版本是2006年1月发表的BGP-4,即RFC 4271<sup>~</sup>4278  
>> 可以将BGP-4简写为BGP  
>> 基本思路  
>>> 因特网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。比较合理的做法是在AS之间交换“可达性”信息  
>>> 因此，BGP只能是力求寻找到一条能够到达目的网络且比较好的路由（不能兜圈子），而非寻找一条最佳路由  
>>
>> BGP 发言人  
>>> 每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“BGP发言人”  
>>> 一般来说，两个BGP发言人都是通过一个共享网络连接在一起的，而BGP发言人往往就是BGP边界路由器  
>>
>> 特点  
>>> 交换路由的结点数较少  
>>>> BGP协议交换路由信息的结点数量级是自治系统数的量级，要比这些自治系统中的网络数少很多  
>>>
>>> 路由选择比较简单  
>>>> 每一个自治系统中边界路由器的数目是很少的，这就使得自治系统之间的路由选择不致过分复杂  
>>>
>>> 支持CIDR  
>>>> 使得路由表的规模可以比较小，效率较高  
>>>
>>> 部分更新  
>>>> 在刚运行时，BGP的邻站是交换整个的BGP路由表。但以后只在发生变化时更新有变化的部分。这样做对节省网络宽带和减少路由器的处理开销方面都有好处  
>>>
>>
