### 定义  
> (OSI/RM)数据链路层是在物理层提供比特流服务的基础上，建立`相邻结点之间的`的数据链路，通过`差错控制`提供`数据帧`在信道上的`“透明”传输`。  

#### 一、基本概念  
> （1）链路(link)：是一条无源的`点到点`的物理线路`段`，`中间没有任何其他的交换结点`。(一条链路只是一条通路的一个组成部分)	  

> （2）数据链路(data link)：除了物理线路外，还必须有`通信协议`来控制这些数据的传输。若把实现这些协议的`硬件和软件加到链路上`，就构成了数据链路。  
> **数据链路 = 链路 + 协议**  
> * 链路中通信双方的信道使用形式不同，会相应有不同的控制协议  
> 
> 数据链路层使用的信道主要有以下两种类型：  
>> 1·`点对点信道`：使用一对一的点对点通信方式。  
>> 2·`广播信道`：使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送。  
>
> （3）帧(Frame)：数据链路层的数据单位  
![image1](https://github.com/onshero/PCN/blob/picture/各层的数据单位.png)
#### 二、基本功能  
> **（1）封装成帧**：在一段数据的前后分别添加`首部`和`尾部`，确定帧的界限，也就是进行`帧定界`。  
> ![image2](https://github.com/onshero/PCN/blob/picture/封装成帧.png)
>> 方法举例：采用特殊的`控制字符`，例如帧开始符SOH和帧结束符EOT  
>> 正确情况下，受到完整的帧；出错情况下，丢弃不完整的帧  
> 
> **（2）透明传输**  
> 当定界符与数据中的编码重复时，会造成错误的解读。（内容相关性冲突——`不透明`）  
> 解决方法：`字符/字节填充`  
>> 发送端的数据链路层——在内容数据中出现控制字符的前面插入一个`转义字符`，如“ESC”；  
>> 接收端的数据链路层——在将数据送往网络层之前`删除`插入的转义字符  
>> 如果转义字符也在数据当中，那么应在转义字符前也插入一个转义字符。当接受端收到连续的两个转义字符时，就删除其中前`面`那个  
>
> **（3）差错控制**  
> 不“可靠”传输可能出现的问题：
> * 比特差错   10100000 ——&gt; 10100010
> * 帧丢失     3 2 1 ——&gt; 2 1
> * 帧重复     3 2 1 ——&gt; 3 2 2 1
> * 帧失序     3 2 1 ——&gt; 2 3 1
> *一旦发生比特差错，很难自动回复；*  
> *中间通信设备不掌握全部通信内容；*  
> 因此在现有网络实现中，数据链路层只提供`比特差错检测`。  
> 方法：广泛使用`循环冗余检验` `CRC` 方法  
>> 核心运算：`模2除法`——与算术除法类似，但每一位的结果不影响其他位，即不向上借位，所以实际上就是`异或`。  
>> `CRC的原理`  
>>> 在发送端，先把数据划分为`组`。假定每组 k 个比特。
>>> 假设待传送的一组数据 M = 101001 （现在 k=6）。  
>>> 在 M 的后面再添加供差错检测用的 n 位`冗余码`一起发送。  
>>
>> `冗余码的计算`  
>>>  1·移位  
>>> 首先，用二进制的模2运算进行2<sup>n</sup>乘 M 的运算，这相当于在 M 的后面添加 n 个 0。  
>>> 2·求余  
>>> 得到的（k+n）位的数除以事先选好的长度位（n+1）位的除数 P （CRC生成多项式），得出商是Q 而余数是R ，余数R 比除数P 少1位，即R 是n 位。  
>>
>> `帧检验序列 FCS` ——即在数据后面添加上的冗余码  
>>> CRC 和 FCS 并不等同  
>>> CRC——检测方法  
>>> FCS——冗余码  
>>> FSC 可用 CRC 得出，但 CRC 并不是获得 FCS 的唯一方法  
>>
>> `接收端对收到的帧进行 CRC 检验`  
>>> 接收端用收到的数据除以 P  
>>> 若得出的余数 R =0 ，则判断这个帧没有差错，就接受  
>>> 否则判定这个帧有差错，就丢弃  
>>
>> **注意**  
>>> 生成的多项式P 的选取十分关键。（CRC16、CRC32、CRC-CCITT...）  
>>> 只要经过严格的挑选，并使用位数足够多的除数P ，那么出现检测不到的差错的概率就很小。  
>>> 但这种检测方法并不能确定究竟是哪一个或哪几个比特出现了差错。只能做到`无差错接受`。  
>>> 要做到“`可靠传输`”（即发送什么就受到什么）就必须再加上`确认`和`重传`机制。将在TCP层去考虑。
#### 点对点协议 PPP（Point-to—Point Protocol）  
> 最初设计是为了两个通过拨号或专线方式连接起来的对等节点之间数据包传输提供一种封装协议。  
> 传统的拨号上网——用户到ISP的链路使用PPP协议  
> 应满足的需求  
>> 封装、透明、简单的差错检测  
>> 建立链路所需参数的协商  
>> 向上支持多种网络层协议、向下兼容多类型链路  
>> 动态分配网络地址、自动检测连接状态  
>
> 组成  
>> 一个将IP数据报`封装`到串行链路的方法  
>> `链路控制`协议LCP（Link Control Protocol）  
>> `网络控制`协议NCP（Network Control Protocol） 
>
> 五个运行阶段
>> 建立链路（LCP）  
>> 验证（PAP/CHAP）  
>> 网络控制协商（NCP）  
>> 会话维持  
>> 终止PPP  
>
> 封装——PPP协议的帧格式  
>> ![image3](https://github.com/onshero/PCN/blob/picture/PPP协议的帧格式1.png)
>> ![image4](https://github.com/onshero/PCN/blob/picture/PPP协议的帧格式2.png)
>
> 透明传输  
>> `异步传输`：将比特分成小组传输，发送端可随时发送，接收端却不知何时到达——面向字节  
>>> 使用一种特殊字符填充法  
>>> 将信息字段中的每一个`0x7E`字节转变成2字节序列（`0x7D, 0x5E`）。  
>>> 若信息字段中出现一个`0x7D`字节，将其转变成2字节序列（`0x7D, 0x5D`）。  
>>> 若信息字段中出现ASCII码的控制字符（即数值小于 0x20 的字符），则在该字符前加入一个 0x7D 字节，同时将该字符的编码加以改变  
>>
>> `同步传输`：以固定的时钟节拍来发送数据信号。——面向比特  
>>> 协议规定采用硬件来完成比特填充——零比特填充（更快捷）——定界符是0x7E(01111110)  
>>> 在发送端将扫描到的5个连续的1后面填入一个0  
>>> 在接收端将扫描发现的5个连续的1后面的一个0删除  
>
> 差错检测  
>> PPP不提供使用序号和确认的可靠传输  
>> 使用 FCS 来保证无差错接受  
>
> PPP协议的应用
>> 传统的拨号上网  
>>> ![image5](https://github.com/onshero/PCN/blob/picture/PPP协议的应用.png)  
>>
>> 扩展：PPPoE（以太网上的PPP）  
>>> DSL中常用的协议  
>>> 以太网与拨号网络之间的中继协议  
>
#### 广播信道的数据链路层  
> 局域网最主要的特点：网络为一个单位所拥有，且地理范围和站点数目均有限。  
> 目前最常用的局域网络——以太网（Ethernet）  
> (1)局域网的拓扑——广播信道  
>> 集线器——星形网  
>> 干线耦合器——环形网  
>> 匹配电阻——总线网、树形网  
>
> 广播信道除封装、透明、差错外的特殊问题  
>> 身份标识  
>> 信道争用
>
> (2)以太网——两个标准（差别很小）  
>> DIX Ethernet V2 是世界上第一个以太网的规约 1982  
>> IEEE 的 802.3 标准 1983  
>>> * 逻辑链路控制 LIC（Logical Link Control） 子层 并不发挥实际作用，一般不考虑  
>>> * 媒体接入控制 MAC（Medium Access Control） 子层  
>>>> MAC层的硬件地址  
>>>>>在局域网中，“MAC地址” = 适配器地址 = 硬件地址 = 物理地址  
>>>>>> MAC 地址——48 位  
>>>>>>> 前三个字节——IEEE 的注册管理机构 RA 分配给厂家。  
>>>>>>> 后三个字节——由厂家自行指派，称为扩展标识符，必须保证生产出来的适配器没有重复地址。  
>>>>
>>>> MAC的帧封装格式  
>>>>> ![image6](https://github.com/onshero/PCN/blob/picture/MAC%20帧封装格式.png)  
>>>>> 类型字段用来标志上一层使用的是什么格式，以便把收到的MAC帧的数据上交给上一层的这个协议。  
>>>>> 数据字段的正式名称是MAC 客户数据字段  
>>>>>> 最小长度64字节-18字节的首部和尾部=数据字段的最小长度  
>>>>
>>>> 适配器的作用  
>>>>> 网络接口板又称为`通信适配器`（adapter）或`网络接口卡` NIC（Network Interface Card），或“`网卡`”。是MAC协议的实现载体。  
>>>>> ![image7](https://github.com/onshero/PCN/blob/picture/适配器的重要功能.png)  
>>>>
>>>> 适配器检查 MAC 地址  
>>>>> 适配器（网卡）从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址。  
>>>>> 如果是发往本站的帧则收下，然后再进行其他的处理。  
>>>>> 否则就将此帧丢弃，不再进行其他的处理。以太网不负责重传丢弃的帧。  
>>>>
>>>> 无效的MAC帧
>>>>> 帧的长度不是整数个字节；  
>>>>> 数据字段的长度不再46—1500字节之间；  
>>>>> MAC 帧长度不在 64—1518 字节之间；  
>>>>> 数据字段的长度与长度字段的值不一致；  
>>>>> 用收到的帧检验序列 FCS 查出有差错；  
>>>>
>
#### CSMA/CD协议  
> 解决信道争用的方法  
>> 静态划分信道（不适用局域网）  
>>> 频分复用  
>>> 时分复用  
>>> 波分复用  
>>> 码分复用  
>>
>> 动态媒体接入控制（多点接入）  
>>> 随机接入——碰撞检测  
>>> 受控接入——如令牌或轮询  
>
> CSMA/CD 协议  
>> 最初以太网是将许多计算机都连接到一根总线上，但如果多方发送，接收端无法识别  
>> CSMA/CD 表示 Carrier Sense Multiple Access with Collision Detection。载波监听多点接入/碰撞检测  
>>> 多点接入：许多计算机以多点接入的方式连接在一根总线上。  
>>> 载波监听：每一个站在发送数据之前先要检测一下总线上是否有其他计算机发送数据，如有，则暂时不要发送数据，以免发生碰撞。发送过程中也要监听，判断电压是否正常，对其进行相应处理。  
>>> 碰撞检测：计算机边发送数据边检测信道上的信号电压大小。  
>>
>> 基本原理  
>>> 每一个正在发送数据的站，一旦`发现`总线上出现了碰撞，就要立即`停止`发送，免得继续浪费网络资源，然后`等待`一段随机时间后再次发送。
>>> 发现碰撞：通过接口处电压的判断；  
>>>> 当某个站监听到总线是空闲时，也可能总线并非真正是空闲的。  
>>>> A向B发送的信息，要经过一定时间后才能传送到B（时间延迟）。若B在A发送信息到达B之前发送自己的帧，则必然在某个时间与A发送的帧发送碰撞。碰撞结果是两个帧都变得无用。  
>>>> 将时间延迟作为一个`窗口期`：  
>>>>> 两倍的端到端往返时延  
>>>>> 以太网的端到端往返时延 2τ 称为争用期，或碰撞窗口。  
>>>>
>>>> 停止时间（随机时间）  
>>>>> 方法： 采用截断二进制指数退避算法  
>>>>> 定义了基本的退避时间 争用窗口时间 2τ 。  
>>>>> 定义重传次数 k ，k<+10，即 k = Min`[ 重传次数, 10 ]`  
>>>>> 整数集合 `[0,1，···，（2k-1）]`  
>>>>> 当重传次数达16次仍不能成功时即丢弃该帧，并向高层报告  
>>>>
>>>> 争用期的长度  
>>>>> 对于 10 Mb/s传统以太网取 51.2 μs 为争用期的长度  
>>>>> 在争用期内可发送512 bit，即64字节  
>>>>> 传统以太网最短有效帧长为64字节  
>>>> 当A和B发现冲突时，会发出强化碰撞的一系列的信号，是为了加上干扰信号，使得其他终端能及时发现有碰撞产生，避免后面碰撞的发生。  
>>
>> CSMA/CD协议是一种半双工的工作模式（双向交替通信），虽在目前交换机构成的以太网当中没有直接的发挥作用，但它仍是802.3协议中最基本的一个功能。在各类网卡中也是作为一种基本协议存在。  
#### 局域网扩展设备  
> 物理层扩展——集线器  
>> 集线器：使用电子器件来模拟实际电缆线的工作，像是一种多接口的转发器。  
>>> 传播是广播式的。CSMA/CD要发挥作用。  
>>> 特点：会使碰撞域变大，独占式  
>>> 优点：  
>>>> 跨域通信。  
>>>> 扩大了局域网覆盖的地理范围。  
>>>
>>> 缺点：
>>>> 扩展范围及站点数有限  
>>>> 碰撞域增大了，但总的吞吐量并未提高  
>>>> 如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。  
>
> 数据链路层扩展——网桥、交换机(多接口网桥)  
>> 网桥（Network Bridge）的基本形式
>>> 根据MAC帧的目的地址对收到的帧进行转发。  
>>> 具有过滤帧的功能。当 网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的MAC 地址，然后再确定将此帧转发到哪一个接口。  
>>
>> 网桥的内部结构 
>>> ![image8]()  
>>
>> 网桥的好处  
>>> 使各网段成为隔离开的碰撞域  
>>> 过滤通信量，增大吞吐量  
>>> 扩大物理范围，增加站点数目  
>>> 提高了可靠性，不同网段不会互相干扰  
>>> 可互连不同物理层、不同 MAC 子层和不同速率（如10 Mb/s和 100Mb/s以太网）的局域网  
>>
>> 网桥的缺点  
>>> 存储转发增加了时延  
>>> 在MAC 子层并没有流量控制功能  
>>> 只适合用户数不太多（不超过几百个）和通信量不太大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞——广播风暴。    
>>
>> 透明网桥  
>>> “透明”是指局域网上的站点并不知道所发的帧将经过哪几个网桥。（即无需手动配置转发表）  
>>> 是一种即插即用设备，其标准是 IEEE 802.1D  
>>> 自学习建立转发表  
>>>> 基本思想：若从A 发出的帧从接口X 进入了某网桥，那么从这个接口出发沿相反方向一定可把一个帧传送到A  
>>>> 网桥每收到一个帧时，就记下其源地址和进入网桥的接口，作为转发表的一个项目，除此之外，还有帧进入该网桥的时间。以反映当前网络的最新拓扑状态。  
>>>> 在转发帧时，则是根据收到的帧首部中的目的地址查找转发表，决定转发的接口。  
>>>
>>> 生成树算法  
>>>> 当设置了并行的两个或多个网桥时，为了避免在回路中产生无限循环的问题，白白消耗网络资源采用生成树算法。  
>>
>> 以太网交换机（最常用,全双工的工作方式）  
>>> 既可以看作是交换式集线器，又可看做一种改进的多接口网桥。  
>>> 与传统的网桥相比，能提高更多的端口、更好的性能、更强的管理功能以及更便宜的价格  
>>> 特点:  
>>>> 自学习  
>>>> 转发/过滤  
>>>> 消除回路  
>>>> 每个接口都可以直接与主机相连，全双工工作方式  
>>>> 采用交换矩阵，大大提高它的交换性能  
>>>> 能同时连通许多对的接口，进行无碰撞传输  
>>>> 使用专用的交换结构芯片，交换速率较高  
>>>
>>> 交换机  
>>>> 存储转发  
>>>> 直通式：接收数据帧之后，马上判断目的地址，直接进行数据转发，把数据帧存储下来，然后再进行差错检测，再转发  
>>>>> 提高了转发效率，但可能使已出现比特差错的帧在网络中继续传播  
>>>
